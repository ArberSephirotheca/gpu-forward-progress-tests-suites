#!amber

SET ENGINE_DATA fence_timeout_ms 10000

SHADER compute test GLSL
#version 460

// Contents of injectionSwitch: [0.0, 1.0]
layout(set = 0, binding = 1) uniform buf1 {
 vec2 injectionSwitch;
};
#extension GL_KHR_shader_subgroup_basic : enable
#extension GL_KHR_shader_subgroup_ballot : enable
#extension GL_KHR_shader_subgroup_vote : enable
#extension GL_KHR_shader_subgroup_basic : enable
#extension GL_KHR_memory_scope_semantics : enable
layout(set = 0, binding = 0) buffer Buf {
 uint buf[];
};
layout(local_size_x = 128, local_size_y = 1, local_size_z = 1) in;
void main()
{
 uint subgroup_id = gl_SubgroupID;
 uint subgroup_size = gl_SubgroupSize;
 uint subgroup_local_id = gl_SubgroupInvocationID;
 uint num_workgroup = gl_NumWorkGroups.x;
 uint workgroup_size = gl_WorkGroupSize.x;
 uint workgroup_id = ((gl_WorkGroupID) - uvec3(0u, 0u, 0u)).x;
 uint workgroup_base = workgroup_size * workgroup_id;
 uint virtual_gid = (~ (~ (((0u + ((clamp((((((injectionSwitch.x > injectionSwitch.y)) || ((injectionSwitch.x < injectionSwitch.y)))) ? ((clamp(uint(uvec2((((false ? (workgroup_size) : 0u | (workgroup_base)))), (min((clamp(0u, 0u, ((max((uint(uvec2(min(0u, 0u), (0u >> (uint(2u)))))), min(0u, 0u)))))), 0u)))), uint(uvec2(((uint(((uvec2(0u | (workgroup_base), 1u)) >> uvec2(0u, 0u))))), (uint(uvec3((~ (((true ? ~ (0u) : (workgroup_base))))), (uint((injectionSwitch.x)) << (uint(1u))), 0u))))), uint(uvec2((0u | (workgroup_base)), 0u))))) : (136180u)), (((injectionSwitch.x < injectionSwitch.y)) ? ((clamp(uint(uvec2((0u | (workgroup_base)), ((((((bool(bvec4(bool(bool(((injectionSwitch.x > injectionSwitch.y)))), true, true, false)))) && true)) ? (workgroup_size) : (clamp((max(0u, 0u)), ((0u) | (0u)), 0u)))))), uint(uvec2((0u | (workgroup_base)), (~ (((true ? ~ (0u) : (workgroup_base))))))), uint(uvec2((0u | ((false ? (workgroup_id) : (((workgroup_base)) >> 0u)))), 0u))))) : (136180u)), ((((true && (injectionSwitch.x < (max(injectionSwitch.y, injectionSwitch.y)))))) ? ((clamp(uint(uvec2(((min(0u, 0u)) | (workgroup_base)), 0u)), uint(uvec2(((false ? (atomicOr(subgroup_size, workgroup_base)) : (0u | (((workgroup_base)) / 1u)))), (~ (((true ? ~ (((true ? 0u : (((true ? workgroup_base : (workgroup_id))))))) : (workgroup_base))))))), uint(uvec2((0u | (workgroup_base)), 0u))))) : (136180u))))))) + (uint(uvec2(subgroup_id, uint((injectionSwitch.x))))) * (0u ^ (subgroup_size)) + subgroup_local_id)));
 uint next_virtual_gid = (max((clamp(workgroup_base, (clamp(workgroup_base, workgroup_base, ((uint(uvec2((workgroup_base) + 0u, 0u)))))), workgroup_base)) + (((false || (false)) ? (subgroup_local_id) : ((subgroup_id * subgroup_size) + 0u))) + ((subgroup_local_id + 1) % subgroup_size), (max(((min(((((clamp(workgroup_base, ((((max(clamp(workgroup_base, workgroup_base, ((workgroup_base) + 0u)), clamp(workgroup_base, workgroup_base, ((((workgroup_base) ^ 0u)) + 0u))))) - 0u)), (uint(uvec4((((~ (~ (workgroup_base)))) << 0u), 1u, 1u, 1u))))) + ((false ? (subgroup_local_id) : ((subgroup_id * subgroup_size) + (((true ? uint(uvec4((uint(uvec4(0u, 1u, 0u, 1u))), 1u, ((((clamp(1u & 1u, 1u & 1u, ((uint(uvec3((min(uint(uint(1u & ((((1u) | (1u))) | 0u))), uint(uint(1u & 1u)))), ((((1u) / 1u)) / 1u), 0u))))))) / 1u)), ((0u) | 0u))) : (subgroup_local_id))))))) + ((subgroup_local_id + 1) % subgroup_size)) | ((clamp(workgroup_base, (clamp(workgroup_base, workgroup_base, ((workgroup_base) + 0u))), workgroup_base)) + (((uint(uint(false ? (subgroup_local_id) : ((subgroup_id * subgroup_size) + ((uint(uvec2(uint(uvec4(((clamp(uint(uvec4(((0u) >> 0u), 1u, 0u, 1u)), (min(uint(uvec4(((0u) >> 0u), 1u, 0u, 1u)), uint(uvec4(((0u) >> 0u), 1u, 0u, 1u)))), uint(uvec4(((0u) >> 0u), 1u, 0u, 1u))))), 1u, ((((clamp(1u & 1u, 1u & 1u, 1u & 1u))) / 1u)), 0u)), (0u << (((uint(4u)) * 1u))))))))))))) + ((subgroup_local_id + 1) % subgroup_size))) | (((clamp(workgroup_base, ((((max(clamp(workgroup_base, workgroup_base, ((workgroup_base) + 0u)), clamp(workgroup_base, workgroup_base, ((((workgroup_base) ^ 0u)) + 0u))))) - 0u)), (uint(uvec4((((~ (~ (workgroup_base)))) << 0u), 1u, 1u, 1u))))) + ((false ? (subgroup_local_id) : ((subgroup_id * subgroup_size) + (((true ? uint(uvec4((uint(uvec4(0u, 1u, 0u, 1u))), 1u, ((((clamp(1u & 1u, 1u & 1u, ((uint(uvec3((min(uint(uint(1u & ((((1u) | (1u))) | 0u))), uint(uint(1u & 1u)))), ((((1u) / 1u)) / 1u), 0u))))))) / 1u)), ((0u) | 0u))) : (subgroup_local_id))))))) + ((subgroup_local_id + 1) % subgroup_size)) | ((clamp(workgroup_base, (clamp(workgroup_base, workgroup_base, ((workgroup_base) + 0u))), workgroup_base)) + (((uint(uint(false ? (subgroup_local_id) : ((subgroup_id * subgroup_size) + ((uint(uvec2(uint(uvec4(((clamp(uint(uvec4(((0u) >> 0u), 1u, 0u, 1u)), (min(uint(uvec4(((0u) >> 0u), 1u, 0u, 1u)), uint(uvec4(((0u) >> 0u), 1u, 0u, 1u)))), uint(uvec4(((0u) >> 0u), 1u, 0u, 1u))))), 1u, ((((clamp(1u & 1u, 1u & 1u, 1u & 1u))) / 1u)), 0u)), (0u << (((uint(4u)) * 1u))))))))))))) + ((subgroup_local_id + 1) % subgroup_size)))), (min(((clamp(workgroup_base, ((((max(clamp(workgroup_base, workgroup_base, ((workgroup_base) + 0u)), clamp(workgroup_base, workgroup_base, ((((max((workgroup_base) ^ 0u, (workgroup_base) ^ 0u)))) + 0u))))) - 0u)), (uint(uvec4((((~ (~ (workgroup_base)))) << 0u), 1u, 1u, 1u))))) + ((false ? (subgroup_local_id) : ((subgroup_id * subgroup_size) + (uint(uvec4((uint(uvec4(0u, (0u ^ (((true ? 1u : (num_workgroup))))), 0u, 1u))), 1u, ((((clamp(1u & 1u, 1u & 1u, ((uint(uvec3((min(uint(uint(1u & 1u)), uint(uint(1u & 1u)))), 1u, 0u))))))) / 1u)), ((0u) | 0u))))))) + ((subgroup_local_id + 1) % subgroup_size)) | (0u + (((((clamp(workgroup_base, (clamp(workgroup_base, workgroup_base, ((workgroup_base) + 0u))), workgroup_base)) + (((uint(uint(false ? (subgroup_local_id) : ((((subgroup_id * subgroup_size) + ((uint(uvec2(((uint(uvec4((uint(uvec4(((0u) >> 0u), 1u, 0u, 1u))), 1u, ((((clamp(1u & 1u, 1u & 1u, 1u & 1u))) / 1u)), 0u))) ^ 0u), (0u << (((uint(4u)) * 1u)))))))) | ((subgroup_id * subgroup_size) + ((uint(uvec2(((uint(uvec4((uint(uvec4(((0u) >> 0u), 1u, 0u, 1u))), 1u, ((((clamp(1u & 1u, 1u & 1u, 1u & 1u))) / 1u)), 0u))) ^ 0u), (0u << (((uint(4u)) * 1u))))))))))))))) + ((subgroup_local_id + 1) % subgroup_size))) | (((clamp(workgroup_base, (clamp(workgroup_base, workgroup_base, ((workgroup_base) + 0u))), workgroup_base)) + (((uint(uint(false ? (subgroup_local_id) : ((subgroup_id * subgroup_size) + ((uint(uvec2(((uint(uvec4((uint(uvec4(((0u) >> 0u), 1u, 0u, 1u))), 1u, ((((clamp(1u & 1u, 1u & 1u, 1u & 1u))) / 1u)), 0u))) ^ 0u), (0u << (((uint(4u)) * 1u))))))))))))) + ((subgroup_local_id + 1) % subgroup_size)))))), ((clamp(workgroup_base, ((((max(clamp(workgroup_base, workgroup_base, ((workgroup_base) + 0u)), clamp(workgroup_base, workgroup_base, ((((workgroup_base) ^ 0u)) + 0u))))) - 0u)), (uint(uvec4((((~ (~ (workgroup_base)))) << 0u), 1u, 1u, 1u))))) + ((false ? (max((subgroup_local_id), (max((0u | ((subgroup_local_id))), (subgroup_local_id))))) : ((((subgroup_id * subgroup_size) + (uint(uvec4((uint(uvec4(0u, 1u, (~ (~ (0u))), 1u))), 1u, ((((clamp(1u & 1u, 1u & 1u, ((((uint(uvec3(((true ? (min(uint(uint(1u & 1u)), uint((min(uint(1u & 1u), ((uint(1u & 1u)) + 0u)))))) : (workgroup_base))), 1u, 0u))) | (0u << (uint(6u))))))))) / 1u)), ((0u) | 0u)))))) | (((subgroup_id * subgroup_size) + (uint(uvec4((uint(uvec4(0u, 1u, (~ (~ (0u))), 1u))), 1u, ((((clamp(1u & 1u, 1u & 1u, ((((uint(uvec3(((max((~ (~ ((true ? (min(uint(uint(1u & ((false ? (subgroup_size) : 1u)))), uint(uint(1u & 1u)))) : (workgroup_base))))), (true ? (min(uint(uint(1u & ((false ? (subgroup_size) : 1u)))), uint(uint(1u & 1u)))) : (workgroup_base))))), 1u, 0u))) | ((uint(uint((0u ^ (0u))))) << (uint(6u))))))))) / 1u)), ((0u) | 0u))))))))) + (((((clamp(subgroup_local_id + 1, ((((subgroup_local_id + 1) | 0u)) - (0u ^ 0u)), subgroup_local_id + 1)))) / 1u) % subgroup_size)) | ((clamp(workgroup_base, (clamp(workgroup_base, workgroup_base, ((workgroup_base) + 0u))), workgroup_base)) + (((((uint(uint(false ? (subgroup_local_id) : ((subgroup_id * subgroup_size) + ((uint(uvec2(uint(uvec4((uint(uvec4(((0u) >> 0u), 1u, 0u, 1u))), 1u, ((((((clamp(1u & 1u, 1u & 1u, 1u & 1u))) / 1u) | (((clamp(1u & 1u, 1u & 1u, 1u & 1u))) / 1u)))), 0u)), (0u << ((min(((uint(4u)) * 1u), ((uint(4u)) * 1u)))))))))))))) - 0u))) + ((subgroup_local_id + 1) % subgroup_size))))))), (((true ? clamp(workgroup_base, (clamp(workgroup_base, workgroup_base, ((((uint(uvec2(0u ^ (workgroup_base), 0u))))) + 0u))), workgroup_base) : (0u ^ ((subgroup_local_id)))))) + ((false ? (subgroup_local_id) : ((subgroup_id * subgroup_size) + 0u))) + ((true ? (((((((~ (~ (subgroup_local_id)))) | 0u) + 1) % subgroup_size)) ^ 0u) : (packUnorm4x8(vec4(6161.9747, - 5166.3002, 6.1, - 1.6)))))))));
 ((uint(uint((0u >> (~ (~ ((((uint(1u))) << 0u)))))))) | (((true ? buf[virtual_gid] = ((1) << (int((injectionSwitch.x)) << (int(4)))) : (next_virtual_gid)))));
 if((clamp(((true ? subgroup_local_id + (clamp((clamp((0 ^ ((~ (~ ((((int(ivec3((((max((((clamp(1, 1, 1))) ^ (0 ^ 0)), (((max((((clamp(1, 1, 1))) ^ (0 ^ 0)) - 0, (((clamp(1, 1, 1))) ^ (0 ^ 0)) - 0))))))) - 0), (1 | 1), (clamp((max(1, 1)), 1, 1))))))) * 1))))), (~ (~ ((((int(ivec3((((((max((((clamp(1, 1, 1))) ^ (0 ^ 0)), ((((true ? (((((((clamp(1, 1, 1))) ^ (0 ^ 0)) - 0) | 0)) + 0) : (59515)))))))) - 0) | ((int(ivec3(((max((((clamp(1, 1, 1))) ^ (0 ^ 0)), (((((clamp(1, 1, 1))) ^ (0 ^ 0)) - 0))))) - 0, 1, 1)))))), (1 | 1), (clamp((max(1, 1)), 1, 1))))))) * 1))), (~ (~ ((((int(ivec3((((max((((clamp(1, 1, 1))) ^ (0 ^ 0)), (((((clamp(1, 1, 1))) ^ (0 ^ 0)) - 0))))) - 0), (1 | 1), (clamp((max(1, 1)), 1, 1))))))) * 1))))), 1, (1 * (((1) / 1))))) : (workgroup_id))), subgroup_local_id + 1, (max((~ (~ (subgroup_local_id + 1))), subgroup_local_id + ((1) ^ int((injectionSwitch.x))))))) < ((((min((min(0u ^ (((true ? subgroup_size : (packUnorm4x8(vec4(- 88.04, (clamp(8.3, 8.3, 8.3)), - 1.4, - 684.626)))))), (min(0u, 0u)) ^ (subgroup_size))), (min(0u ^ (((true ? subgroup_size : (packUnorm4x8(vec4(- 88.04, (clamp(8.3, 8.3, 8.3)), - 1.4, - 684.626)))))), (min(0u, 0u)) ^ (subgroup_size))))))) - uint((injectionSwitch.x))))
  {
   int i = 0;
   buf[next_virtual_gid] = 2;
  }
 else
  {
   buf[next_virtual_gid] = 2;
  }
}

END

BUFFER tester DATA_TYPE uint32 SIZE 8388096 FILL 0
BUFFER expected DATA_TYPE uint32 SIZE 8388096 FILL 2
BUFFER injection DATA_TYPE vec2<float> DATA
 0.0 1.0
END

PIPELINE compute test_pipe
  ATTACH test
  BIND BUFFER tester AS storage DESCRIPTOR_SET 0 BINDING 0 
  BIND BUFFER injection AS uniform DESCRIPTOR_SET 0 BINDING 1 

END

RUN test_pipe 65532 1 1
EXPECT tester EQ_BUFFER expected
