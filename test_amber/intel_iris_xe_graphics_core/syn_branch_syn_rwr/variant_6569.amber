#!amber

SET ENGINE_DATA fence_timeout_ms 10000

SHADER compute test GLSL
#version 460

#ifndef REDUCER
#define _GLF_ZERO(X, Y)                   (Y)
#define _GLF_ONE(X, Y)                    (Y)
#define _GLF_FALSE(X, Y)                  (Y)
#define _GLF_TRUE(X, Y)                   (Y)
#define _GLF_IDENTITY(X, Y)               (Y)
#define _GLF_DEAD(X)                      (X)
#define _GLF_FUZZED(X)                    (X)
#define _GLF_WRAPPED_LOOP(X)              X
#define _GLF_WRAPPED_IF_TRUE(X)           X
#define _GLF_WRAPPED_IF_FALSE(X)          X
#define _GLF_SWITCH(X)                    X
#define _GLF_MAKE_IN_BOUNDS_INT(IDX, SZ)  clamp(IDX, 0, SZ - 1)
#define _GLF_MAKE_IN_BOUNDS_UINT(IDX, SZ) clamp(IDX, 0u, SZ - 1u)
#endif


layout(set = 0, binding = 1) uniform buf1 {
 vec2 injectionSwitch;
};
#extension GL_KHR_shader_subgroup_ballot : enable
#extension GL_KHR_shader_subgroup_vote : enable
#extension GL_KHR_shader_subgroup_basic : enable
#extension GL_KHR_memory_scope_semantics : enable
layout(set = 0, binding = 0) buffer Buf {
 uint buf[];
};
layout(local_size_x = 128, local_size_y = 1, local_size_z = 1) in;
void main()
{
 uint subgroup_id = gl_SubgroupID;
uint subgroup_size = 16;
 uint subgroup_local_id = gl_SubgroupInvocationID;
 uint num_workgroup = gl_NumWorkGroups.x;
 uint workgroup_size = gl_WorkGroupSize.x;
 uint workgroup_id = gl_WorkGroupID.x;
 uint workgroup_base = workgroup_size * workgroup_id;
 uint virtual_gid = workgroup_base + subgroup_id * subgroup_size + subgroup_local_id;
 uint next_virtual_gid = workgroup_base + subgroup_id * subgroup_size + ((subgroup_local_id + 1) % subgroup_size);
 uint read_1 = atomicLoad(buf[virtual_gid], 4, 64, 0);
 atomicStore(buf[next_virtual_gid], uint(read_1 + 1), 4, 64, 4);
 uint read_2 = atomicLoad(buf[virtual_gid], 4, 64, 0);
 if(subgroup_local_id + 1 < subgroup_size)
  {
   switch(_GLF_SWITCH(0))
    {
     case 80:
     for(     mat2x4(5096.6675, -6271.4841, -82.25, -4.0, 5.0, -5.6, -751.293, 28.99);
 (6.4 > fma(-76.35, 9.5, -86.08)); uintBitsToFloat(mix(subgroup_size, subgroup_size, true)))
      {
       int _GLF_SWITCH_0_0v[91], _GLF_SWITCH_0_1v[2];
       uvec2 _GLF_SWITCH_0_2v, _GLF_SWITCH_0_3v[75], _GLF_SWITCH_0_4v;
       if(mix(true, true, (mat4(756.103, 577.874, -6.2, -87.66, 913.670, -120.164, -7817.1580, -9350.9334, -3.4, 4.1, 984.294, 6529.2454, 65.04, -4562.9185, 4.2, 3.5) != mat4(33.62, -62.83, 653.322, 8713.8481, 6.0, 3.5, 8.2, -96.74, 479.990, 79.42, -9.4, 3.5, 5.1, -1.6, -9.0, 94.20))))
        {
         ;
         while((mat2x4(-2468.1350, -977.133, 4.9, 5173.1077, 5.7, 921.783, 3355.2125, 1.6) == mat2x4(109.604, -670.333, 592.452, 6.7, 2.3, -52.18, 9.9, -8.3)))
          {
           mat4x3 _GLF_SWITCH_0_5v;
           mat3x2 _GLF_SWITCH_0_6v;
           bvec3(bvec4(true, true, true, true));
           sinh(vec4(-263.625, 3194.2246, 7.3, -27.67));
           ivec2(49933, 76529);
           ((mat3x2(-98.22, 83.82, -4392.8347, -68.89, 80.67, -1.3) * vec3(-8857.7081, 6.5, -262.773)));
           ;
           ivec3 _GLF_SWITCH_0_7v[76];
           mat4x2 _GLF_SWITCH_0_8v;
          }
         while(true)
          {
           sign((int(9.9) * ivec3(-86901, 50138, 10662)));
           mat2x3(2.3, 6274.5245, 2.9, -387.231, -9.2, -1.0);
           ivec3 _GLF_SWITCH_0_9v[17];
          }
         mat4 _GLF_SWITCH_0_10v;
         for(float _GLF_SWITCH_0_11v[10]; false; mat3x2(-6.4, 0.8, 14.77, 6846.3551, -538.260, 47.85))
          {
           ivec3(47383, -11858, 41511);
           uvec4 _GLF_SWITCH_0_12v;
           ;
           (-88515 | ivec2(-25393, -58630));
           mat2x3 _GLF_SWITCH_0_13v[35], _GLF_SWITCH_0_14v, _GLF_SWITCH_0_15v;
           mat4x3 _GLF_SWITCH_0_16v[48], _GLF_SWITCH_0_17v, _GLF_SWITCH_0_18v;
           (mat2(0.8, -8806.8385, -59.54, -1.3) * mat3x2(4075.0227, 98.17, 6.1, 4.7, 26.84, 1132.9220));
           mat2x3 _GLF_SWITCH_0_19v, _GLF_SWITCH_0_20v[73], _GLF_SWITCH_0_21v;
           ivec4(36162, -23508, -82850, -10097);
          }
         for(         mat3x2(-73.90, -493.854, -99.08, -15.60, -9.7, -27.75);
 (mat3x2(0.0, -10.58, 6747.3128, -1.8, -8.2, 3.5) != (mat3(6.1, 67.60, 5730.2221, -9.2, -937.034, -636.424, 1.5, -311.564, 842.225) , mat3x2(-283.840, 7.3, 9.3, 216.861, 42.93, -3807.6127))); (3.0 / vec4(-1.9, 0.3, 7.1, 3.7)))
          {
           normalize(8.3);
           mat3x4(-8571.8607, 32.53, -7.9, 1449.7044, 30.57, -62.46, -4.3, -1.9, -6.1, 4675.0344, 229.293, -4.7);
           ;
           mat3 _GLF_SWITCH_0_22v, _GLF_SWITCH_0_23v, _GLF_SWITCH_0_24v[79];
           vec4 _GLF_SWITCH_0_25v;
           mat4x3 _GLF_SWITCH_0_26v, _GLF_SWITCH_0_27v;
           bvec4(true, false, true, false);
          }
         mat2x4(-22.91, 2.4, -2589.5358, 1.0, 1841.5024, 6659.3471, -8146.9583, 4666.3424);
        }
       mat2x3 _GLF_SWITCH_0_28v, _GLF_SWITCH_0_29v[91], _GLF_SWITCH_0_30v[29];
       if(false)
        {
         mat2 _GLF_SWITCH_0_31v, _GLF_SWITCH_0_32v[63], _GLF_SWITCH_0_33v;
         int _GLF_SWITCH_0_34v[44], _GLF_SWITCH_0_35v;
         {
          ivec2 _GLF_SWITCH_0_36v;
          bvec4((subgroup_local_id < read_2), bvec2(false, true), true);
          mat4 _GLF_SWITCH_0_37v[69];
         }
         for(uvec4 _GLF_SWITCH_0_38v; false; mat2(-5.7, 786.059, -3638.8198, 1.1))
          {
           mat4x2(8608.6563, 12.62, 336.032, -3.1, -7.0, -55.05, -763.346, 1035.5996);
           bvec2 _GLF_SWITCH_0_39v, _GLF_SWITCH_0_40v;
          }
         bvec2 _GLF_SWITCH_0_41v;
         for(         (next_virtual_gid * uvec4(168467u, 113922u, 119046u, 175523u));
 any(_GLF_SWITCH_0_41v); ivec2(-75004, -29570))
          {
           ivec4(-11679, -97293, 36647, 31494);
           int _GLF_SWITCH_0_42v, _GLF_SWITCH_0_43v, _GLF_SWITCH_0_44v;
           mat2x3(8.4, 5.8, 35.37, 733.432, 6.9, 3.8);
           uvec4 _GLF_SWITCH_0_45v, _GLF_SWITCH_0_46v, _GLF_SWITCH_0_47v;
           _GLF_SWITCH_0_46v;
           _GLF_SWITCH_0_45v.ar;
           bvec3 _GLF_SWITCH_0_48v;
           ivec4(-3983, 84992, 74272, -62165);
          }
         uvec4(175001u, 72470u, 30403u, 56802u);
         bvec4(true, false, false, true);
         while((_GLF_SWITCH_0_41v.x))
          {
           ((mat4x2(-4962.1560, -4.3, -98.40, 3.3, -9266.5659, -6996.2855, -5.2, -4.0) * mat4(-9792.2948, 584.690, 9.2, -5.8, 755.334, 1.6, 324.038, 8399.4903, 52.74, -2.6, 1139.7146, -1.0, 5.9, 0.1, 6901.4436, -8.1)) * mat2x4(-1.7, 517.676, 261.970, -0.5, 8.7, 1.1, 5.2, -399.719));
           ivec4(-80196, -43382, 82615, 70504);
           bvec3(true, false, false);
           ;
           ;
           uvec3 _GLF_SWITCH_0_49v[55], _GLF_SWITCH_0_50v, _GLF_SWITCH_0_51v;
           vec4(-0.7, 25.62, -0.8, -755.565)[1];
           bitfieldInsert(uvec4(14722u, 188093u, 23993u, 8283u), uvec4(80316u, 6570u, 80705u, 151885u), 48956, (_GLF_SWITCH_0_35v --));
          }
        }
       else
        {
         {
          uvec3(111295u, 120708u, 63955u);
         }
         if((7.7 != sinh(41.10)))
          {
           uint _GLF_SWITCH_0_52v[67], _GLF_SWITCH_0_53v[91], _GLF_SWITCH_0_54v;
          }
         else
          {
           ;
          }
         ivec3 _GLF_SWITCH_0_55v, _GLF_SWITCH_0_56v[91], _GLF_SWITCH_0_57v;
         for(mat2x3 _GLF_SWITCH_0_58v; true; bvec4(true, false, true, false))
          {
           bvec4 _GLF_SWITCH_0_59v, _GLF_SWITCH_0_60v;
          }
         for(mat4x2 _GLF_SWITCH_0_61v, _GLF_SWITCH_0_62v[1], _GLF_SWITCH_0_63v[69]; (mat3x2(-8574.6369, 3.6, -935.394, 481.416, 3329.4237, 1.4) == mat3x2(_GLF_SWITCH_0_28v)); mat3x4(-5235.8956, -2.9, -4256.3419, 2232.7100, -9.3, 3.7, 0.9, -382.358, 2.0, 9648.5531, -8.0, 74.37))
          {
          }
         _GLF_SWITCH_0_55v;
         bool _GLF_SWITCH_0_64v;
         while(_GLF_SWITCH_0_64v)
          {
           vec3(80.10, -3.5, 7.5);
           uvec3 _GLF_SWITCH_0_65v;
           ;
           mat3x4 _GLF_SWITCH_0_66v[15], _GLF_SWITCH_0_67v[27], _GLF_SWITCH_0_68v;
           ;
           (mat4x2(-679.647, 6.6, -0.2, -781.497, -2.6, -6658.4279, -6.0, 6.6) * mat2x4(-4.2, -9.5, 1.8, -7678.1897, -2.8, -822.879, 9998.2327, -77.90));
           bitfieldExtract(subgroup_local_id, 80548, (~ -36336));
           mat3 _GLF_SWITCH_0_69v;
           mat3 _GLF_SWITCH_0_70v[2];
          }
         for(         ivec4(64316, -68769, -60113, 31994);
 _GLF_SWITCH_0_64v; mat4x2(_GLF_SWITCH_0_28v))
          {
           int _GLF_SWITCH_0_71v[37], _GLF_SWITCH_0_72v, _GLF_SWITCH_0_73v;
           uint _GLF_SWITCH_0_74v[94], _GLF_SWITCH_0_75v, _GLF_SWITCH_0_76v;
           -1736.5982;
           ((read_2 & uvec3(61148u, 106397u, 44731u)) | uvec3(34599u, 125410u, 72192u));
          }
        }
       bvec3 _GLF_SWITCH_0_77v;
       {
        {
         switch(_GLF_SWITCH(int(_GLF_ZERO(0.0, injectionSwitch.x))))
          {
           case 0:
           case 49:
           ivec3(51906, 18598, 81773);
           case 19:
           ;
           break;
           case 47:
           uvec4 _GLF_SWITCH_2_0v, _GLF_SWITCH_2_1v[76], _GLF_SWITCH_2_2v[55];
           case 61:
           min(vec2(-6.3, -2.8), injectionSwitch);
           default:
           1;
          }
        }
        bool _GLF_SWITCH_0_78v, _GLF_SWITCH_0_79v;
        (-8.0 , uvec2(32063u, 186901u));
        {
         (_GLF_SWITCH_0_28v --);
         mat2x3(-4003.6654, -1.5, 3726.5897, 8.3, 192.172, 179.296);
         mat3(8.7, 9815.9800, 0.6, 56.46, -4898.2512, 8.7, -952.269, 6.7, -7.4);
         _GLF_SWITCH_0_2v.y;
         ivec4(-40660, 68159, -11707, 28977);
         outerProduct(vec4(7257.3068, -6534.2806, 22.53, 27.46), injectionSwitch);
         bvec2 _GLF_SWITCH_0_80v[86];
        }
        do
         {
          next_virtual_gid;
          uvec2 _GLF_SWITCH_0_81v;
          mat2(94.20, 1.9, 19.57, 0.0);
          mat2x3(mat4(-4354.5866, -8.7, -4.5, -6.9, -51.41, 9702.5664, -644.008, 855.412, -8082.8157, -81.58, 8802.8084, -0.6, -5.9, -0.7, -9234.2018, -3.0));
          mat3(-9.8, -771.252, -9253.3928, -3582.3195, -584.843, -0.5, 4040.8050, -45.25, -0.6);
          (+ mat3x2(777.556, 0.6, -2864.9973, 5.2, -715.469, -1576.3652));
          mat2 _GLF_SWITCH_0_82v, _GLF_SWITCH_0_83v[15], _GLF_SWITCH_0_84v;
          uvec2 _GLF_SWITCH_0_85v, _GLF_SWITCH_0_86v;
          vec2 _GLF_SWITCH_0_87v;
         }
        while(((mat4x2(-9.8, -9514.4861, 57.19, 81.21, 4.9, -2.5, 6.2, -7.3)) == mat4x2(-93.01, 8.4, 6.8, 433.290, -2.0, -606.968, 1.5, -8.5)));
        bvec4(true, true, true, true);
        isinf(vec4(-6520.1120, -407.466, 72.05, 7.7));
        for(        (vec4(-0.8, 8052.0701, 4754.4230, 6.3) / -8.4);
 _GLF_SWITCH_0_79v; -53.25)
         {
          uvec4 _GLF_SWITCH_0_88v[93], _GLF_SWITCH_0_89v[49], _GLF_SWITCH_0_90v[62];
          vec3(-841.150, -2551.5316, 5005.3517);
          vec3(-458.117, -3.3, -762.114);
          ivec2 _GLF_SWITCH_0_91v;
         }
       }
      }
     case 0:
     int i = 0;
     atomicStore(buf[next_virtual_gid], uint(read_1 + 1 == read_2) + 1, 4, 64, 4);
     break;
     default:
     1;
    }
  }
 else
  {
   switch(_GLF_SWITCH((0 ^ 0)))
    {
     case 88:
     (+ mat3(5.7, 1.6, -0.2, 574.432, -35.86, -60.72, 9466.3325, -8.0, 8.2));
     case 0:
     case 29:
     case 67:
     case 25:
     case 97:
     case 23:
     case 35:
     case 63:
     case 86:
     case 83:
     atomicStore(buf[next_virtual_gid], uint(read_1 + 1 == read_2) + 1, 4, 64, 4);
     break;
     case 72:
     vec2 _GLF_SWITCH_1_0v, _GLF_SWITCH_1_1v, _GLF_SWITCH_1_2v;
     default:
     1;
    }
  }
}

END

BUFFER tester DATA_TYPE uint32 SIZE 8388096 FILL 0
BUFFER expected DATA_TYPE uint32 SIZE 8388096 FILL 2
BUFFER injection DATA_TYPE vec2<float> DATA
 0.0 1.0
END

PIPELINE compute test_pipe
  ATTACH test
  BIND BUFFER tester AS storage DESCRIPTOR_SET 0 BINDING 0 
  BIND BUFFER injection AS uniform DESCRIPTOR_SET 0 BINDING 1 

END

RUN test_pipe 65532 1 1
EXPECT tester EQ_BUFFER expected
